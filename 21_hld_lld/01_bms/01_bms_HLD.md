# **Book My Show**

Youtube : https://www.youtube.com/watch?v=lBAwJgoO3Ek

Medium : https://medium.com/@narengowda/bookmyshow-system-design-e268fefb56f5

Geeksforgeeks : https://www.geeksforgeeks.org/design-bookmyshow-a-system-design-interview-question/

To get movie data from theatre in 2 ways
- BMS can make API calls to threatre system
    - In BMS we can create light weight threads to make async API calls to movie theatres systems
- Read DB of threatre system and cache in BMS


## Features : 
1. Highly concurrent (95K bookings per day)
2. Responsive UI
3. Multiple cities
4. Payments
5. Movie suggestions
6. Comments and rating
7. Movie info
8. Send ticket by sms, mail, whatsapp

<u>7:30 time architecture</u>

## Components : 
**Load balancer** : round robin, hashing, weighted RR, least connected server

**Varnish**: front end caching system. (To save search query result)

**CDN** cloufare (for video, image, pages)

**App Server** : Java, Spring, Swagger, Hibernate or Python or Node.JS

**Cache** : Place by theatre, Save info related to movies, seat ordering. We can use memcache or \
Redis(**Distributed** and **persistant**).

**DB** : Good to have both types of DB
1. **SQL**: We need **ACID** property. For example : Relation in DB, country, cities, multiple theatre, multiple screen, \
   each screen have, multiple rows of seats, different tier of seats, movie playing. We need proper relationship to handle \
   this type of data. Here data is constant. We need to handle transcations as well (booking). \
   Use master slave architecture. Write in master and read from slave.
2. **NoSql** : big data, changing Movie related information. crew, actors, comments, rating \
   In casandra we can specify the **replication** nodes count. **Distrubuted by geolocation**. Since nodes distrbuted. \
   We replicate the data in other nodes as well(by specifying the replication factor). 

**Async workers** : It is required for pdf generation, send mail(gmail), sms (twilio), gcm (notification in app). These are \
network I/O and adds latency. So we can't these synchronously along with ticket booking. App server adds a message to queue. \
Here we can use Python celery.
**Celery** is an open source asynchronous task queue or job queue which is based on distributed message passing. While it \
supports scheduling, its focus is on operations in real time. Similar frameworks are present in Java and go as well.

**Business Inteligence** :  
1. **Hadoop** : User activities and logs can be dumped in hadoop. (HDFS)  We can run PIG or Hive query to extract the user behaviour.\
   We can train our model using these data. Can be used for **recommendation** system.
2. **Spark** or **storm** to get real time analysis. By sending data though kakfa. We can get **latest trends**, **fraud detection**, \
   understand user activity and behaviour.

**Payment Gateway** : third party payment gateway like JusPay. It has lot of vendors like credit card, banking applications and wallets.

## Working Steps :
1. Customer comes to BMS portal, add the location filter. Sort and go to specific movie. If the user is using app we can use GPS \  
   location of phone. If he is using laptop, we can find location using ISP provider. Based on location we can suggest movies \
   released in the theatre nearby.
2. User selects the movie, sees all the available timings for the selected movie. 
3. Then user selects the seat to book it. BMS should lock the seat for next 10 mins while booking to avoid conflict. The seat \
   should be released if ticket is not booked in **10 mins**. 
4. User then proceeds to payment. BMS should get ack from payment gateway.
5. Once payment is successful, Theatre returns a Unique id, that will be saved in App server. 
6. Based on the unique ID, a ticket will be generated by BMS along with a QR code. 
7. Copy of the ticket will be immediately shown to the user. 
8. Also a message will be added in queue to send same copy via Email. 
9. QR code should be shared with theater, so that customer can show it will entrying the theater.

## Deployment Environment : 
1. It is built of AWS platform.
2. It uses microservice architecture. Like every component is separated out and run independelty.
3. App server and workers are hosted on EC2. 
4. CDN is **Cloudfare**.
5. Trailers, gallary is saved in S3.
6. Frontend : reactJS, BootstrapJS, JS, CSS, Tomcat
7. App server : Java, Spring, Swagger, Hibernate
8. DB: Mysql
9. Cache : HaselCache
10. Queue : **RabbitMQ**
11. Deployment : Docker and Ansible
12. Logging : Log4J, **Elasticsearch**, Logstash, and Kibana (ELK). Logstash based on lot of filtering conditions. \
    It can send notification via hipchat, whatsapp or open Jira bug. In Kibana we can create dashboard to see error rate \
    or request rate.  
13. Loadbalancer : **Nginx**

<u>23:55 time db tables</u>

## Sql tables : 
Places, theater, screen, tier, seats, ticket, user, movie, offers

## Nosql tables : 
Comments, Ratings, Movie Info, Cast, Artists, Analytics Data, Reviews, Trailers Gallery


## APIs Needed :
1. GetListOfCities()
2. GetListOfEventsByCity(CityId) 
3. GetLocationsByCity(CityId) 
4. GetLocationsByEventandCity(cityid, eventid) 
5. **GetEventsByLocationandCity**(CityId, LocationId) 
6. **GetShowTiming**(eventid, locationid) 
7. **GetAvailableSeats**(eventid, locationid, showtimeid) 
8. VerifyUserSelectedSeatsAvailable(eventid, locationid, showtimeid, seats) 
9. **BlockUserSelectedSeats**() 
10. **BookUserSelectedSeat**() 
11. GetTimeoutForUserSelectedSeats() 
